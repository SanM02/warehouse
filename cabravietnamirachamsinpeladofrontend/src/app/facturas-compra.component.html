<div class="container-fluid px-4">
  <h1 class="mt-3">Facturas de Compra</h1>
  <ol class="breadcrumb mb-4">
    <li class="breadcrumb-item"><a routerLink="/dashboard">Dashboard</a></li>
    <li class="breadcrumb-item active">Facturas de Compra</li>
  </ol>

  <!-- Estadísticas -->
  <div class="row" *ngIf="estadisticas && mostrarEstadisticas">
    <div class="col-xl-3 col-md-6">
      <div class="card bg-primary text-white mb-4">
        <div class="card-body">
          <h6>Total Facturas</h6>
          <h3>{{ estadisticas.total_facturas }}</h3>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card bg-warning text-white mb-4">
        <div class="card-body">
          <h6>Pendientes</h6>
          <h3>{{ estadisticas.facturas_pendientes }}</h3>
          <small>{{ formatearMoneda(estadisticas.monto_total_pendiente) }}</small>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card bg-success text-white mb-4">
        <div class="card-body">
          <h6>Pagadas</h6>
          <h3>{{ estadisticas.facturas_pagadas }}</h3>
          <small>{{ formatearMoneda(estadisticas.monto_total_pagado) }}</small>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card bg-danger text-white mb-4">
        <div class="card-body">
          <h6>Vencidas</h6>
          <h3>{{ estadisticas.facturas_vencidas }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="card mb-4">
    <div class="card-header">
      <i class="fas fa-filter me-1"></i>
      Filtros de Búsqueda
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Buscar</label>
          <input 
            type="text" 
            class="form-control" 
            [(ngModel)]="filtros.search"
            placeholder="Número, proveedor, timbrado..."
            (keyup.enter)="aplicarFiltros()">
        </div>
        
        <div class="col-md-3">
          <label class="form-label">Proveedor</label>
          <select class="form-select" [(ngModel)]="filtros.proveedor">
            <option value="">Todos los proveedores</option>
            <option *ngFor="let proveedor of proveedores" [value]="proveedor.id">
              {{ proveedor.nombre }}
            </option>
          </select>
        </div>
        
        <div class="col-md-2">
          <label class="form-label">Estado</label>
          <select class="form-select" [(ngModel)]="filtros.estado">
            <option *ngFor="let estado of estados" [value]="estado.value">
              {{ estado.label }}
            </option>
          </select>
        </div>
        
        <div class="col-md-2">
          <label class="form-label">Tipo</label>
          <select class="form-select" [(ngModel)]="filtros.tipo_factura">
            <option *ngFor="let tipo of tiposFactura" [value]="tipo.value">
              {{ tipo.label }}
            </option>
          </select>
        </div>
        
        <div class="col-md-2">
          <label class="form-label">Desde</label>
          <input 
            type="date" 
            class="form-control" 
            [(ngModel)]="filtros.fecha_emision__gte">
        </div>
        
        <div class="col-md-2">
          <label class="form-label">Hasta</label>
          <input 
            type="date" 
            class="form-control" 
            [(ngModel)]="filtros.fecha_emision__lte">
        </div>
        
        <div class="col-md-3">
          <label class="form-label d-block">&nbsp;</label>
          <div class="form-check">
            <input 
              class="form-check-input" 
              type="checkbox" 
              id="vencidas"
              [(ngModel)]="filtros.vencidas">
            <label class="form-check-label" for="vencidas">
              Solo vencidas
            </label>
          </div>
        </div>
        
        <div class="col-md-3">
          <label class="form-label d-block">&nbsp;</label>
          <div class="form-check">
            <input 
              class="form-check-input" 
              type="checkbox" 
              id="proximasVencer"
              [(ngModel)]="filtros.proximas_vencer">
            <label class="form-check-label" for="proximasVencer">
              Próximas a vencer (7 días)
            </label>
          </div>
        </div>
        
        <div class="col-md-6">
          <label class="form-label d-block">&nbsp;</label>
          <button class="btn btn-primary me-2" (click)="aplicarFiltros()">
            <i class="fas fa-search"></i> Buscar
          </button>
          <button class="btn btn-secondary" (click)="limpiarFiltros()">
            <i class="fas fa-times"></i> Limpiar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de facturas -->
  <div class="card mb-4">
    <div class="card-header">
      <i class="fas fa-file-invoice me-1"></i>
      Listado de Facturas de Compra
      <button class="btn btn-sm btn-success float-end" (click)="abrirModalNueva()">
        <i class="fas fa-plus"></i> Nueva Factura
      </button>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Número</th>
              <th>Proveedor</th>
              <th>Fecha Emisión</th>
              <th>Vencimiento</th>
              <th>Tipo</th>
              <th>Estado</th>
              <th>Total</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="cargando">
              <td colspan="8" class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
              </td>
            </tr>
            <tr *ngIf="!cargando && facturas.length === 0">
              <td colspan="8" class="text-center">No se encontraron facturas</td>
            </tr>
            <tr *ngFor="let factura of facturas">
              <td>{{ factura.numero_factura }}</td>
              <td>{{ factura.proveedor_nombre }}</td>
              <td>{{ factura.fecha_emision | date: 'dd/MM/yyyy' }}</td>
              <td>
                <span *ngIf="factura.fecha_vencimiento">
                  {{ factura.fecha_vencimiento | date: 'dd/MM/yyyy' }}
                  <span 
                    *ngIf="factura.esta_vencida" 
                    class="badge bg-danger ms-1">
                    VENCIDA
                  </span>
                </span>
                <span *ngIf="!factura.fecha_vencimiento" class="text-muted">-</span>
              </td>
              <td>
                <span class="badge" [ngClass]="factura.tipo_factura === 'credito' ? 'bg-info' : 'bg-secondary'">
                  {{ factura.tipo_factura === 'credito' ? 'Crédito' : 'Contado' }}
                </span>
              </td>
              <td>
                <span class="badge" [ngClass]="getEstadoBadgeClass(factura.estado)">
                  {{ factura.estado | titlecase }}
                </span>
              </td>
              <td class="fw-bold">{{ formatearMoneda(factura.total) }}</td>
              <td>
                <div class="btn-group" role="group">
                  <button 
                    class="btn btn-sm btn-info" 
                    (click)="abrirModalEditar(factura)"
                    title="Ver/Editar">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button 
                    class="btn btn-sm btn-success" 
                    (click)="marcarComoPagada(factura)"
                    *ngIf="factura.estado === 'pendiente' || factura.estado === 'vencida'"
                    title="Marcar como pagada">
                    <i class="fas fa-check"></i>
                  </button>
                  <button 
                    class="btn btn-sm btn-warning" 
                    (click)="cancelarFactura(factura)"
                    *ngIf="factura.estado === 'pendiente'"
                    title="Cancelar">
                    <i class="fas fa-ban"></i>
                  </button>
                  <button 
                    class="btn btn-sm btn-danger" 
                    (click)="eliminarFactura(factura)"
                    title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginación -->
      <nav *ngIf="totalPages > 1">
        <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" (click)="cambiarPagina(currentPage - 1)">Anterior</a>
          </li>
          <li 
            class="page-item" 
            *ngFor="let pagina of paginasArray"
            [class.active]="pagina === currentPage">
            <a class="page-link" (click)="cambiarPagina(pagina)">{{ pagina }}</a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" (click)="cambiarPagina(currentPage + 1)">Siguiente</a>
          </li>
        </ul>
      </nav>

      <div class="text-center text-muted">
        Mostrando {{ facturas.length }} de {{ totalFacturas }} facturas
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" [class.show]="mostrarModal" [style.display]="mostrarModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ modoEdicion ? 'Editar Factura de Compra' : 'Nueva Factura de Compra' }}
        </h5>
        <button type="button" class="btn-close" (click)="cerrarModal()"></button>
      </div>
      <div class="modal-body">
        <form>
          <!-- Información básica -->
          <div class="row g-3 mb-4">
            <div class="col-md-3">
              <label class="form-label">Número de Factura *</label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="facturaActual.numero_factura"
                name="numero_factura"
                required>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Proveedor *</label>
              <select 
                class="form-select" 
                [(ngModel)]="facturaActual.proveedor"
                name="proveedor"
                required>
                <option [value]="0">Seleccione...</option>
                <option *ngFor="let proveedor of proveedores" [value]="proveedor.id">
                  {{ proveedor.nombre }}
                </option>
              </select>
            </div>
            
            <div class="col-md-2">
              <label class="form-label">Fecha Emisión *</label>
              <input 
                type="date" 
                class="form-control" 
                [(ngModel)]="facturaActual.fecha_emision"
                name="fecha_emision"
                required>
            </div>
            
            <div class="col-md-2">
              <label class="form-label">Tipo *</label>
              <select 
                class="form-select" 
                [(ngModel)]="facturaActual.tipo_factura"
                name="tipo_factura"
                required>
                <option value="contado">Contado</option>
                <option value="credito">Crédito</option>
              </select>
            </div>
            
            <div class="col-md-2">
              <label class="form-label">Fecha Vencimiento</label>
              <input 
                type="date" 
                class="form-control" 
                [(ngModel)]="facturaActual.fecha_vencimiento"
                name="fecha_vencimiento"
                [required]="facturaActual.tipo_factura === 'credito'">
            </div>
          </div>

          <div class="row g-3 mb-4">
            <div class="col-md-3">
              <label class="form-label">Timbrado</label>
              <input 
                type="text" 
                class="form-control" 
                [(ngModel)]="facturaActual.timbrado"
                name="timbrado">
            </div>
            
            <div class="col-md-2">
              <label class="form-label">Estado</label>
              <select 
                class="form-select" 
                [(ngModel)]="facturaActual.estado"
                name="estado">
                <option value="pendiente">Pendiente</option>
                <option value="pagada">Pagada</option>
                <option value="cancelada">Cancelada</option>
              </select>
            </div>
          </div>

          <!-- Detalles de la factura -->
          <h6 class="border-bottom pb-2 mb-3">Detalles de la Factura</h6>
          
          <div class="table-responsive mb-3">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th style="width: 35%">Producto *</th>
                  <th style="width: 10%">Cantidad *</th>
                  <th style="width: 15%">Precio Unit. *</th>
                  <th style="width: 15%">Subtotal</th>
                  <th style="width: 10%">Lote</th>
                  <th style="width: 10%">Venc. Lote</th>
                  <th style="width: 5%"></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let detalle of facturaActual.detalles; let i = index">
                  <td>
                    <select 
                      class="form-select form-select-sm" 
                      [(ngModel)]="detalle.producto"
                      [name]="'producto_' + i"
                      (change)="onProductoChange(detalle)"
                      required>
                      <option [value]="0">Seleccione...</option>
                      <option *ngFor="let producto of productos" [value]="producto.id">
                        {{ producto.codigo }} - {{ producto.nombre }}
                      </option>
                    </select>
                  </td>
                  <td>
                    <input 
                      type="number" 
                      class="form-control form-control-sm" 
                      [(ngModel)]="detalle.cantidad"
                      [name]="'cantidad_' + i"
                      (ngModelChange)="calcularTotales()"
                      min="1"
                      required>
                  </td>
                  <td>
                    <input 
                      type="number" 
                      class="form-control form-control-sm" 
                      [(ngModel)]="detalle.precio_unitario"
                      [name]="'precio_' + i"
                      (ngModelChange)="calcularTotales()"
                      min="0"
                      required>
                  </td>
                  <td>
                    <input 
                      type="text" 
                      class="form-control form-control-sm" 
                      [value]="formatearMoneda(detalle.cantidad * detalle.precio_unitario)"
                      readonly>
                  </td>
                  <td>
                    <input 
                      type="text" 
                      class="form-control form-control-sm" 
                      [(ngModel)]="detalle.lote"
                      [name]="'lote_' + i">
                  </td>
                  <td>
                    <input 
                      type="date" 
                      class="form-control form-control-sm" 
                      [(ngModel)]="detalle.fecha_vencimiento_lote"
                      [name]="'venc_lote_' + i">
                  </td>
                  <td>
                    <button 
                      type="button" 
                      class="btn btn-sm btn-danger" 
                      (click)="eliminarDetalle(i)">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <button type="button" class="btn btn-sm btn-primary mb-4" (click)="agregarDetalle()">
            <i class="fas fa-plus"></i> Agregar Detalle
          </button>

          <!-- Totales -->
          <div class="row">
            <div class="col-md-8"></div>
            <div class="col-md-4">
              <table class="table table-sm">
                <tr>
                  <td class="text-end"><strong>Subtotal:</strong></td>
                  <td class="text-end">{{ formatearMoneda(facturaActual.subtotal) }}</td>
                </tr>
                <tr>
                  <td class="text-end">
                    <label>Descuento:</label>
                  </td>
                  <td>
                    <input 
                      type="number" 
                      class="form-control form-control-sm text-end" 
                      [(ngModel)]="facturaActual.descuento"
                      name="descuento"
                      (ngModelChange)="calcularTotales()"
                      min="0">
                  </td>
                </tr>
                <tr>
                  <td class="text-end">
                    <label>Impuestos:</label>
                  </td>
                  <td>
                    <input 
                      type="number" 
                      class="form-control form-control-sm text-end" 
                      [(ngModel)]="facturaActual.impuestos"
                      name="impuestos"
                      (ngModelChange)="calcularTotales()"
                      min="0">
                  </td>
                </tr>
                <tr>
                  <td class="text-end"><strong>TOTAL:</strong></td>
                  <td class="text-end"><h5>{{ formatearMoneda(facturaActual.total) }}</h5></td>
                </tr>
              </table>
            </div>
          </div>

          <!-- Observaciones -->
          <div class="row">
            <div class="col-12">
              <label class="form-label">Observaciones</label>
              <textarea 
                class="form-control" 
                [(ngModel)]="facturaActual.observaciones"
                name="observaciones"
                rows="3"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModal()">Cancelar</button>
        <button 
          type="button" 
          class="btn btn-primary" 
          (click)="guardarFactura()"
          [disabled]="cargando">
          <span *ngIf="cargando" class="spinner-border spinner-border-sm me-1"></span>
          {{ modoEdicion ? 'Actualizar' : 'Guardar' }}
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop fade" [class.show]="mostrarModal" *ngIf="mostrarModal"></div>
