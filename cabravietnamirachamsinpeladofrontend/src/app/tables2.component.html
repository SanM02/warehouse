<div class="container-fluid px-4">
  <div class="d-flex justify-content-between align-items-start">
    <div>
      <h1 class="mt-3">Gestión de Inventario</h1>
      <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a routerLink="/dashboard">Dashboard</a></li>
        <li class="breadcrumb-item active">Inventario</li>
      </ol>
    </div>
    <button class="btn btn-primary mt-3" *ngIf="!mostrarFormulario" (click)="mostrarFormularioNuevo()">
      <i class="fas fa-plus-circle me-1"></i>
      Agregar Nuevo Producto
    </button>
  </div>

  <!-- FORMULARIO NUEVO PRODUCTO -->
  <div class="card mb-4 shadow" *ngIf="mostrarFormulario">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="fas fa-box-open"></i> Nuevo Producto
      </h5>
    </div>
    
    <div class="card-body">
      <form>
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">
              <i class="fas fa-barcode"></i>
              Código
            </label>
            <input type="text" class="form-control" [(ngModel)]="nuevoProducto.codigo" name="codigo">
          </div>
          
          <div class="col-md-5">
            <label class="form-label">
              <i class="fas fa-tag"></i>
              Nombre <span class="text-danger">*</span>
            </label>
            <input type="text" class="form-control" [(ngModel)]="nuevoProducto.nombre" name="nombre" required>
          </div>
          
          <div class="col-md-4">
            <label class="form-label">
              <i class="fas fa-folder"></i>
              Categoría
            </label>
            <input type="text" class="form-control" [(ngModel)]="nuevoProducto.categoria" name="categoria">
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">
              <i class="fas fa-copyright"></i>
              Marca
            </label>
            <input type="text" class="form-control" [(ngModel)]="nuevoProducto.marca" name="marca">
          </div>
          
          <div class="col-md-4">
            <label class="form-label">
              <i class="fas fa-car"></i>
              Modelo Compatible
            </label>
            <input type="text" class="form-control" [(ngModel)]="nuevoProducto.modeloCompatible" name="modeloCompatible">
          </div>
          
          <div class="col-md-5">
            <label class="form-label">
              <i class="fas fa-map-marker-alt"></i>
              Ubicación Física
            </label>
            <input type="text" class="form-control" [(ngModel)]="nuevoProducto.ubicacion" name="ubicacion" placeholder="Ej: Estante A3">
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-12">
            <label class="form-label">
              <i class="fas fa-align-left"></i>
              Descripción
            </label>
            <textarea class="form-control" [(ngModel)]="nuevoProducto.descripcion" name="descripcion" rows="2"></textarea>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-2">
            <label class="form-label">
              <i class="fas fa-boxes"></i>
              Stock Inicial
            </label>
            <input type="number" class="form-control" [(ngModel)]="nuevoProducto.cantidad" name="cantidad" min="0">
          </div>
          
          <div class="col-md-2">
            <label class="form-label">
              <i class="fas fa-exclamation-triangle"></i>
              Stock Mínimo
            </label>
            <input type="number" class="form-control" [(ngModel)]="nuevoProducto.stockMinimo" name="stockMinimo" min="0">
          </div>
          
          <div class="col-md-4">
            <label class="form-label">
              <i class="fas fa-dollar-sign"></i>
              Precio Costo (₲)
            </label>
            <input type="number" class="form-control" [(ngModel)]="nuevoProducto.precioCosto" name="precioCosto" min="0" (ngModelChange)="calcularPrecioVenta()">
          </div>
          
          <div class="col-md-4">
            <label class="form-label">
              <i class="fas fa-money-bill-wave"></i>
              Precio Venta (₲) <small>(+30%)</small>
            </label>
            <input type="number" class="form-control" [(ngModel)]="nuevoProducto.precioVenta" name="precioVenta" min="0" readonly>
          </div>
          
          <div class="col-md-4">
            <label class="form-label">
              <i class="fas fa-truck"></i>
              Proveedor
            </label>
            <input type="text" class="form-control" [(ngModel)]="nuevoProducto.proveedor" name="proveedor">
          </div>
        </div>
      </form>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <button class="btn btn-success" (click)="guardarNuevoProducto()" [disabled]="guardando">
          <span *ngIf="!guardando">
            <i class="fas fa-save"></i>
            Guardar
          </span>
          <span *ngIf="guardando">
            <i class="fas fa-spinner fa-spin"></i>
            Guardando...
          </span>
        </button>
        <button class="btn btn-secondary" (click)="cancelarNuevo()" [disabled]="guardando">
          <i class="fas fa-times"></i>
          Cancelar
        </button>
      </div>
    </div>
  </div>

  <!-- TABLA DE PRODUCTOS -->
  <div class="card mb-4 shadow">
    
    <!-- Card Header -->
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">
        <i class="fas fa-boxes"></i> Listado de Productos
      </h5>
    </div>

    <!-- Card Body -->
    <div class="card-body">
      
      <!-- Buscador -->
      <div class="mb-3">
        <label class="form-label">
          <i class="fas fa-search"></i>
          Buscar
        </label>
        <input 
          type="text" 
          class="form-control" 
          placeholder="Código, nombre o categoría..." 
          [(ngModel)]="search">
      </div>

      <!-- Tabla -->
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th><i class="fas fa-barcode"></i> Código</th>
              <th><i class="fas fa-tag"></i> Nombre</th>
              <th><i class="fas fa-align-left"></i> Descripción</th>
              <th><i class="fas fa-folder"></i> Categoría</th>
              <th><i class="fas fa-copyright"></i> Marca</th>
              <th><i class="fas fa-car"></i> Modelo</th>
              <th><i class="fas fa-boxes"></i> Stock</th>
              <th><i class="fas fa-exclamation-triangle"></i> Mín</th>
              <th><i class="fas fa-dollar-sign"></i> Costo</th>
              <th><i class="fas fa-money-bill-wave"></i> Venta</th>
              <th><i class="fas fa-map-marker-alt"></i> Ubicación</th>
              <th><i class="fas fa-truck"></i> Proveedor</th>
              <th><i class="fas fa-cogs"></i> Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of productosPaginados; let i = index">
              
              <td><code class="text-muted small">{{ p.codigo || '-' }}</code></td>
              <td class="fw-bold">{{ p.nombre }}</td>
              <td>
                <span *ngIf="p.descripcion">{{ p.descripcion.substring(0, 50) }}{{ p.descripcion.length > 50 ? '...' : '' }}</span>
                <span *ngIf="!p.descripcion" class="text-muted">-</span>
              </td>
              <td>
                <span class="badge bg-secondary" [ngStyle]="getCategoriaBadgeStyle(p.categoria)">
                  {{ p.categoria }}
                </span>
              </td>
              <td>{{ p.marca }}</td>
              <td>{{ p.modeloCompatible }}</td>
              <td>
                <span class="badge bg-info" [class.bg-warning]="p.cantidad < p.stockMinimo">
                  {{ p.cantidad }}
                </span>
              </td>
              <td>
                <span class="badge bg-secondary">{{ p.stockMinimo }}</span>
              </td>
              <td>
                <span class="badge bg-success">₲{{ p.precioCosto | number:'1.0-0' }}</span>
              </td>
              <td>
                <span class="badge bg-primary">₲{{ p.precioVenta | number:'1.0-0' }}</span>
              </td>
              <td>
                <span class="text-muted">
                  <i class="fas fa-map-pin"></i>
                  {{ p.ubicacion || '-' }}
                </span>
              </td>
              <td>{{ p.proveedor || '-' }}</td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button 
                    class="btn btn-outline-primary" 
                    (click)="abrirModalEditar(p)" 
                    title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button 
                    class="btn btn-outline-danger" 
                    (click)="eliminarProducto(p)" 
                    title="Eliminar">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="productosPaginados.length === 0">
              <td colspan="13" class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-2x"></i>
                <p class="mt-2">No hay productos para mostrar</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginación -->
      <div class="text-muted mb-2" *ngIf="productosFiltrados.length > pageSize">
        Mostrando {{ (page - 1) * pageSize + 1 }} - {{ Math.min(page * pageSize, productosFiltrados.length) }} 
        de {{ productosFiltrados.length }} productos
      </div>

      <nav *ngIf="totalPaginas > 1" aria-label="Paginación">
        <ul class="pagination">
          <li class="page-item" [class.disabled]="page === 1">
            <button class="page-link" (click)="page = page - 1" [disabled]="page === 1">
              <i class="fas fa-chevron-left"></i> Anterior
            </button>
          </li>
          
          <li class="page-item" 
              *ngFor="let dummy of [].constructor(totalPaginas); let i = index"
              [class.active]="page === (i+1)">
            <button class="page-link" (click)="page = i + 1">
              {{ i + 1 }}
            </button>
          </li>
          
          <li class="page-item" [class.disabled]="page === totalPaginas">
            <button class="page-link" (click)="page = page + 1" [disabled]="page === totalPaginas">
              Siguiente <i class="fas fa-chevron-right"></i>
            </button>
          </li>
        </ul>
      </nav>

    </div>
  </div>

</div>

<!-- MODAL DE EDICIÓN -->
<div *ngIf="mostrarModalEdicion" class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
    
    <!-- Modal Header -->
    <div class="modal-header">
      <h5 class="modal-title">
        <i class="fas fa-edit"></i> Editar Producto
      </h5>
      <button type="button" class="btn-close" (click)="cerrarModalEdicion()"></button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <form *ngIf="productoEditando">
        
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">
              <i class="fas fa-barcode"></i>
              Código
            </label>
            <input type="text" class="form-control" [(ngModel)]="productoEditando.codigo" name="codigo">
          </div>
          
          <div class="col-md-5">
            <label class="form-label">
              <i class="fas fa-tag"></i>
              Nombre <span class="text-danger">*</span>
            </label>
            <input type="text" class="form-control" [(ngModel)]="productoEditando.nombre" name="nombre" required>
          </div>
          
          <div class="col-md-4">
            <label class="form-label">
              <i class="fas fa-folder"></i>
              Categoría
            </label>
            <input type="text" class="form-control" [(ngModel)]="productoEditando.categoria" name="categoria">
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">
              <i class="fas fa-copyright"></i>
              Marca
            </label>
            <input type="text" class="form-control" [(ngModel)]="productoEditando.marca" name="marca">
          </div>
          
          <div class="col-md-4">
            <label class="form-label">
              <i class="fas fa-car"></i>
              Modelo Compatible
            </label>
            <input type="text" class="form-control" [(ngModel)]="productoEditando.modeloCompatible" name="modeloCompatible">
          </div>
          
          <div class="col-md-5">
            <label class="form-label">
              <i class="fas fa-map-marker-alt"></i>
              Ubicación Física
            </label>
            <input type="text" class="form-control" [(ngModel)]="productoEditando.ubicacion" name="ubicacion" placeholder="Ej: Estante A3">
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-12">
            <label class="form-label">
              <i class="fas fa-align-left"></i>
              Descripción
            </label>
            <textarea class="form-control" [(ngModel)]="productoEditando.descripcion" name="descripcion" rows="3"></textarea>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-2">
            <label class="form-label">
              <i class="fas fa-boxes"></i>
              Stock Actual
            </label>
            <input type="number" class="form-control" [(ngModel)]="productoEditando.cantidad" name="cantidad" min="0">
       </div>
          
          <div class="col-md-2">
            <label class="form-label">
              <i class="fas fa-exclamation-triangle"></i>
              Stock Mínimo
            </label>
            <input type="number" class="form-control" [(ngModel)]="productoEditando.stockMinimo" name="stockMinimo" min="0">
          </div>
          
          <div class="col-md-3">
            <label class="form-label">
              <i class="fas fa-dollar-sign"></i>
              Precio Costo (₲)
            </label>
            <input type="number" class="form-control" [(ngModel)]="productoEditando.precioCosto" name="precioCosto" min="0" (ngModelChange)="calcularPrecioVentaEdicion()">
          </div>
          
          <div class="col-md-3">
            <label class="form-label">
              <i class="fas fa-money-bill-wave"></i>
              Precio Venta (₲) <small>(+30%)</small>
            </label>
            <input type="number" class="form-control" [(ngModel)]="productoEditando.precioVenta" name="precioVenta" min="0" readonly>
          </div>
          
          <div class="col-md-2">
            <label class="form-label">
              <i class="fas fa-truck"></i>
              Proveedor
            </label>
            <input type="text" class="form-control" [(ngModel)]="productoEditando.proveedor" name="proveedor">
          </div>
        </div>

      </form>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button 
        class="btn btn-secondary" 
        (click)="cerrarModalEdicion()" 
        [disabled]="guardando">
        <i class="fas fa-times"></i>
        Cancelar
      </button>
      <button 
        class="btn btn-success" 
        (click)="guardarEdicion()" 
        [disabled]="guardando">
        <span *ngIf="!guardando">
          <i class="fas fa-save"></i>
          Guardar Cambios
        </span>
        <span *ngIf="guardando">
          <i class="fas fa-spinner fa-spin"></i>
          Guardando...
        </span>
      </button>
    </div>
    
    </div>
  </div>
</div>
