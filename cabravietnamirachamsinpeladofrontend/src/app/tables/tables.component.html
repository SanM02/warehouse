<div class="container-fluid px-4">
<h1 class="mt-3">Inventario de Productos</h1>
<ol class="breadcrumb mb-4">
  <li class="breadcrumb-item"><a routerLink="/dashboard">Dashboard</a></li>
  <li class="breadcrumb-item active">Inventario</li>
</ol>
<div class="card mb-4">
  <div class="card-header">
    <i class="fas fa-table me-1"></i>
    Listado de Articulos
  </div>
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-4 mb-2">
        <input type="text" class="form-control" placeholder="Buscar por nombre o categoría..." [(ngModel)]="search">
      </div>
      <div class="col-md-4 mb-2">
        <select class="form-select" [(ngModel)]="filtroCategoria">
          <option value="">Todas las categorías</option>
          <option *ngFor="let cat of categorias" [value]="cat">{{ cat }}</option>
        </select>
      </div>
      <div class="col-md-4 mb-2 text-end">
        <span class="badge bg-primary">Total: {{ productosFiltrados.length }}</span>
      </div>
    </div>
    <table class="table table-hover table-bordered align-middle shadow-sm rounded">
      <thead class="table-primary text-center align-middle">
        <tr>
          <th>Código</th>
          <th>Nombre del repuesto</th>
          <th>Categoría</th>
          <th>Marca</th>
          <th>Modelo compatible</th>
          <th>Descripción</th>
          <th>Stock actual</th>
          <th>Stock mínimo</th>
          <th>Precio de costo</th>
          <th>Precio de venta</th>
          <th>Proveedor</th>
          <th>Fecha de ingreso</th>
          <th>Ubicación física</th>
          <th><i class="fas fa-cogs"></i> Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let producto of productosPagina; trackBy: trackByProductoId" class="text-center">
          <td>{{ producto.codigo }}</td>
          <td class="fw-semibold">{{ producto.nombre }}</td>
          <td>
            <span class="badge" [ngStyle]="getCategoriaBadgeStyle(producto.categoria)">
              {{ producto.categoria }}
            </span>
          </td>
          <td>{{ producto.marca }}</td>
          <td>{{ producto.modeloCompatible }}</td>
          <td>{{ producto.descripcion }}</td>
          <td>
            <ng-container *ngIf="editandoStock[producto.id] !== undefined; else vistaNormal">
              <input type="number" class="form-control form-control-sm d-inline-block w-auto text-center" [(ngModel)]="editandoStock[producto.id]" min="0" style="width:70px;" />
            </ng-container>
            <ng-template #vistaNormal>
              <span class="badge bg-light text-dark fs-6 px-3">{{ producto.cantidad }}</span>
            </ng-template>
          </td>
          <td>{{ producto.stockMinimo }}</td>
          <td><span class="fw-bold text-success">₲{{ producto.precioCosto | number:'1.0-0' }}</span></td>
          <td><span class="fw-bold text-success">₲{{ producto.precioVenta | number:'1.0-0' }}</span></td>
          <td>{{ producto.proveedor }}</td>
          <td>{{ producto.fechaIngreso }}</td>
          <td><span class="badge bg-secondary">{{ producto.ubicacion }}</span></td>
          <td>
            <ng-container *ngIf="editandoStock[producto.id] !== undefined; else botonesEdicion">
              <button class="btn btn-success btn-sm me-1" (click)="guardarStock(producto)" [disabled]="guardando[producto.id]">
                <i class="fas fa-save"></i>
              </button>
              <button class="btn btn-secondary btn-sm" (click)="cancelarEdicion(producto)" [disabled]="guardando[producto.id]">
                <i class="fas fa-times"></i>
              </button>
            </ng-container>
            <ng-template #botonesEdicion>
              <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-warning" (click)="abrirModalEditar(producto)" title="Editar producto">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-danger" (click)="eliminarProducto(producto)" title="Eliminar producto">
                  <i class="fas fa-trash"></i>
                </button>
                <button class="btn btn-outline-success" (click)="iniciarEdicion(producto); sumar(producto)" title="Agregar">
                  <i class="fas fa-plus"></i>
                </button>
                <button class="btn btn-outline-danger" (click)="iniciarEdicion(producto); restar(producto)" [disabled]="producto.cantidad === 0" title="Quitar">
                  <i class="fas fa-minus"></i>
                </button>
              </div>
            </ng-template>
          </td>
        </tr>
      </tbody>
    </table>
    <nav *ngIf="totalPaginas > 1">
      <ul class="pagination justify-content-center">
        <li class="page-item" [class.disabled]="page === 1">
          <button class="page-link" (click)="setPagina(page-1)" [disabled]="page === 1">&laquo;</button>
        </li>
        <li class="page-item" *ngFor="let p of [].constructor(totalPaginas); let i = index" [class.active]="page === (i+1)">
          <button class="page-link" (click)="setPagina(i+1)">{{ i+1 }}</button>
        </li>
        <li class="page-item" [class.disabled]="page === totalPaginas">
          <button class="page-link" (click)="setPagina(page+1)" [disabled]="page === totalPaginas">&raquo;</button>
        </li>
      </ul>
    </nav>
  </div>
</div>

<!-- ============================================ -->
<!-- MODAL DE EDICIÓN DE PRODUCTO -->
<!-- ============================================ -->
<div *ngIf="mostrarModalEdicion" class="modal-backdrop fade show"></div>
<div *ngIf="mostrarModalEdicion" class="modal fade show d-block" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      
      <!-- ENCABEZADO -->
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title">
          <i class="fas fa-edit me-2"></i>Editar Producto
        </h5>
        <button type="button" class="btn-close" (click)="cerrarModalEdicion()"></button>
      </div>

      <!-- CUERPO -->
      <div class="modal-body">
        <form *ngIf="productoEditando">
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Código</label>
              <input type="text" class="form-control" [(ngModel)]="productoEditando.codigo" name="codigo">
            </div>
            <div class="col-md-5">
              <label class="form-label">Nombre <span class="text-danger">*</span></label>
              <input type="text" class="form-control" [(ngModel)]="productoEditando.nombre" name="nombre" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Categoría</label>
              <input type="text" class="form-control" [(ngModel)]="productoEditando.categoria" name="categoria">
            </div>
            <div class="col-md-3">
              <label class="form-label">Marca</label>
              <input type="text" class="form-control" [(ngModel)]="productoEditando.marca" name="marca">
            </div>
            <div class="col-md-4">
              <label class="form-label">Modelo Compatible</label>
              <input type="text" class="form-control" [(ngModel)]="productoEditando.modeloCompatible" name="modeloCompatible">
            </div>
            <div class="col-md-5">
              <label class="form-label">Ubicación Física</label>
              <input type="text" class="form-control" [(ngModel)]="productoEditando.ubicacion" name="ubicacion" placeholder="Ej: Estante A3">
            </div>
            <div class="col-12">
              <label class="form-label">Descripción</label>
              <textarea class="form-control" [(ngModel)]="productoEditando.descripcion" name="descripcion" rows="3"></textarea>
            </div>
            <div class="col-md-2">
              <label class="form-label">Stock Actual</label>
              <input type="number" class="form-control" [(ngModel)]="productoEditando.cantidad" name="cantidad" min="0">
            </div>
            <div class="col-md-2">
              <label class="form-label">Stock Mínimo</label>
              <input type="number" class="form-control" [(ngModel)]="productoEditando.stockMinimo" name="stockMinimo" min="0">
            </div>
            <div class="col-md-3">
              <label class="form-label">Precio Costo (₲)</label>
              <input type="number" class="form-control" [(ngModel)]="productoEditando.precioCosto" name="precioCosto" min="0" (ngModelChange)="calcularPrecioVentaEdicion()">
            </div>
            <div class="col-md-3">
              <label class="form-label">Precio Venta (₲) <small class="text-muted">(+30% automático)</small></label>
              <input type="number" class="form-control bg-light" [(ngModel)]="productoEditando.precioVenta" name="precioVenta" min="0" readonly>
            </div>
            <div class="col-md-2">
              <label class="form-label">Proveedor</label>
              <input type="text" class="form-control" [(ngModel)]="productoEditando.proveedor" name="proveedor">
            </div>
          </div>
        </form>
      </div>

      <!-- PIE DEL MODAL -->
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalEdicion()" [disabled]="guardandoEdicion">
          <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button type="button" class="btn btn-warning" (click)="guardarEdicionCompleta()" [disabled]="guardandoEdicion">
          <span *ngIf="!guardandoEdicion"><i class="fas fa-save me-2"></i>Guardar Cambios</span>
          <span *ngIf="guardandoEdicion"><i class="fas fa-spinner fa-spin me-2"></i>Guardando...</span>
        </button>
      </div>
      
    </div>
  </div>
</div>
</div>