================================================================================
         AUDITORÃA CRÃTICA - SISTEMA DE FACTURACIÃ“N FERRETERÃA J&G
                    DOCUMENTO TÃ‰CNICO PARA PROGRAMADOR
================================================================================
                    Fecha: Enero 2025
                    Prioridad: CRÃTICA - PÃ‰RDIDA DE DATOS
================================================================================

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ğŸš¨ BUG #1: DOBLE RESTA DE STOCK (CRÃTICO)                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DESCRIPCIÃ“N DEL PROBLEMA:
-------------------------
Cuando se crea una factura, el stock se resta DOS VECES del producto, causando
que el inventario muestre cantidades incorrectas (negativas o muy bajas).

ARCHIVOS AFECTADOS:
-------------------
1. cabravietnamirachamsinpeladobackend/inventario/serializers.py (lÃ­neas 117-140)
2. cabravietnamirachamsinpeladobackend/inventario/signals.py (lÃ­neas 6-13)

ANÃLISIS TÃ‰CNICO:
-----------------
El cÃ³digo tiene dos puntos donde se resta el stock:

ğŸ“„ PUNTO 1 - serializers.py (lÃ­neas 117-118):
```python
# Actualizar stock
producto.stock_disponible -= cantidad
producto.save()
```

ğŸ“„ PUNTO 2 - signals.py (lÃ­neas 6-13):
```python
@receiver(post_save, sender=Movimiento)
def actualizar_stock(sender, instance, created, **kwargs):
    if created:
        producto = instance.producto
        if instance.tipo == 'entrada':
            producto.stock_disponible += instance.cantidad
        elif instance.tipo == 'salida':
            producto.stock_disponible -= instance.cantidad  # <-- SEGUNDA RESTA
        producto.save()
```

FLUJO DEL BUG:
--------------
1. Usuario crea factura con producto X, cantidad 5
2. serializers.py lÃ­nea 117: stock_disponible = 100 - 5 = 95 âœ“
3. serializers.py lÃ­nea 133: Crea Movimiento tipo='salida'
4. signals.py se dispara automÃ¡ticamente (post_save)
5. signals.py lÃ­nea 12: stock_disponible = 95 - 5 = 90 âŒ (DOBLE RESTA!)
6. Resultado: Producto muestra stock 90 cuando deberÃ­a ser 95

IMPACTO:
--------
- PÃ©rdida de datos de inventario
- Clientes ven stock incorrecto
- Posibles ventas rechazadas por "stock insuficiente" falso
- Error 500 cuando stock queda en negativo

SOLUCIÃ“N PROPUESTA:
-------------------
OPCIÃ“N A (RECOMENDADA): Eliminar la resta manual del serializer y dejar que
                        SOLO el signal maneje el stock.

ğŸ“„ serializers.py - ELIMINAR las lÃ­neas 116-118:
```python
# ELIMINAR ESTAS LÃNEAS:
# Actualizar stock
producto.stock_disponible -= cantidad
producto.save()
```

El cÃ³digo debe quedar asÃ­ (lÃ­neas ~116-140):
```python
# Validar stock disponible (SIN modificar el stock aquÃ­)
if producto.stock_disponible < cantidad:
    raise serializers.ValidationError(f"Stock insuficiente para {producto.nombre}")

# Crear detalle de factura
DetalleFactura.objects.create(
    factura=factura, 
    producto=producto, 
    cantidad=cantidad, 
    precio_unitario=precio_unitario, 
    subtotal=subtotal_detalle
)

# Crear movimiento de salida (el signal se encarga del stock)
from .models import Movimiento
Movimiento.objects.create(
    producto=producto,
    tipo='salida',
    cantidad=cantidad,
    descripcion=f"Venta (Factura #{factura.numero_factura})",
    usuario=usuario
)
```


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ğŸš¨ BUG #2: SIN TRANSACCIÃ“N ATÃ“MICA (CRÃTICO)              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DESCRIPCIÃ“N DEL PROBLEMA:
-------------------------
El mÃ©todo create() de FacturaSerializer no usa transaction.atomic(), lo que
significa que si ocurre un error a mitad del proceso, quedan datos inconsistentes
en la base de datos.

ARCHIVO AFECTADO:
-----------------
cabravietnamirachamsinpeladobackend/inventario/serializers.py (lÃ­neas 90-172)

ANÃLISIS TÃ‰CNICO:
-----------------
Actualmente el cÃ³digo:
1. Crea la factura
2. Itera sobre detalles y crea cada uno
3. Modifica stock de productos
4. Crea movimientos
5. Actualiza totales de factura

Si hay error en el paso 3 o 4 (ej: segundo producto sin stock), los cambios
del paso 1-2 YA ESTÃN en la base de datos y no se revierten.

El bloque try/except actual (lÃ­neas 90, 164-172) intenta borrar la factura
pero NO revierte:
- Los DetalleFactura creados
- Los cambios de stock en productos
- Los Movimientos creados

SOLUCIÃ“N PROPUESTA:
-------------------
Envolver TODO el mÃ©todo en transaction.atomic():

ğŸ“„ serializers.py - AGREGAR al inicio del mÃ©todo create():
```python
from django.db import transaction

def create(self, validated_data):
    with transaction.atomic():
        detalles_data = validated_data.pop('detalles')
        usuario = self.context['request'].user if 'request' in self.context else None
        
        # ... resto del cÃ³digo ...
```

BENEFICIO:
----------
Si ocurre CUALQUIER error, TODOS los cambios se revierten automÃ¡ticamente.
No hay datos huÃ©rfanos ni inconsistentes.


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    âš ï¸ BUG #3: IVA INCORRECTO (ALTO)                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DESCRIPCIÃ“N DEL PROBLEMA:
-------------------------
El IVA estÃ¡ calculado al 12% cuando en PARAGUAY el IVA es del 10%.

ARCHIVO AFECTADO:
-----------------
cabravietnamirachamsinpeladobackend/inventario/serializers.py (lÃ­nea 156)

CÃ“DIGO ACTUAL (INCORRECTO):
---------------------------
```python
impuesto_total = (subtotal - descuento_total) * Decimal('0.12')  # IVA 12%
```

SOLUCIÃ“N:
---------
```python
impuesto_total = (subtotal - descuento_total) * Decimal('0.10')  # IVA 10% (Paraguay)
```

NOTA ADICIONAL:
---------------
Considerar hacer el IVA configurable desde settings.py o una tabla de
configuraciÃ³n para facilitar cambios futuros.


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    âš ï¸ BUG #4: VALIDACIÃ“N DE STOCK TARDÃA (MEDIO)             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DESCRIPCIÃ“N DEL PROBLEMA:
-------------------------
La validaciÃ³n de stock se hace DENTRO del loop de detalles. Si el tercer
producto no tiene stock, ya se modificaron los dos primeros productos.

ARCHIVO AFECTADO:
-----------------
cabravietnamirachamsinpeladobackend/inventario/serializers.py (lÃ­neas 114-116)

CÃ“DIGO ACTUAL:
--------------
```python
for detalle in detalles_data:
    # ... obtener producto y cantidad ...
    
    # Validar stock disponible
    if producto.stock_disponible < cantidad:
        raise serializers.ValidationError(f"Stock insuficiente para {producto.nombre}")
    
    # Actualizar stock (esto YA pasÃ³ para productos anteriores)
    producto.stock_disponible -= cantidad
    producto.save()
```

SOLUCIÃ“N PROPUESTA:
-------------------
PRE-VALIDAR todo el stock ANTES de hacer cualquier cambio:

```python
def create(self, validated_data):
    with transaction.atomic():
        detalles_data = validated_data.pop('detalles')
        
        # ========== PRE-VALIDACIÃ“N DE STOCK ==========
        for detalle in detalles_data:
            producto = detalle['producto']
            cantidad = detalle['cantidad']
            if producto.stock_disponible < cantidad:
                raise serializers.ValidationError(
                    f"Stock insuficiente para {producto.nombre}. "
                    f"Disponible: {producto.stock_disponible}, Solicitado: {cantidad}"
                )
        
        # ========== CREAR FACTURA Y DETALLES ==========
        # ... resto del cÃ³digo (ya validado) ...
```


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ğŸ“ BUG #5: IMPORTACIONES REPETIDAS (BAJO)                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DESCRIPCIÃ“N DEL PROBLEMA:
-------------------------
El cÃ³digo importa Decimal y Movimiento MÃšLTIPLES VECES dentro del loop,
lo cual es ineficiente aunque no cause errores funcionales.

ARCHIVO AFECTADO:
-----------------
cabravietnamirachamsinpeladobackend/inventario/serializers.py

CÃ“DIGO ACTUAL:
--------------
```python
def create(self, validated_data):
    # ...
    from decimal import Decimal  # Import 1
    subtotal = Decimal('0')
    
    for detalle in detalles_data:
        from decimal import Decimal  # Import 2 (repetido en cada iteraciÃ³n!)
        # ...
        from .models import Movimiento  # Import 3 (repetido en cada iteraciÃ³n!)
    
    from decimal import Decimal  # Import 4 (repetido otra vez!)
```

SOLUCIÃ“N:
---------
Mover TODAS las importaciones al inicio del archivo o al inicio del mÃ©todo:

```python
def create(self, validated_data):
    from decimal import Decimal
    from .models import Movimiento
    
    # ... resto del cÃ³digo SIN imports repetidos ...
```


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘               ğŸ” BUG #6: INCONSISTENCIA EN RECEPCIÃ“N (POTENCIAL)             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DESCRIPCIÃ“N DEL PROBLEMA:
-------------------------
El RecepcionMercaderiaSerializer tiene el MISMO PROBLEMA pero para ENTRADAS.
Hace la suma manual Y crea un Movimiento que dispara el signal.

ARCHIVO AFECTADO:
-----------------
cabravietnamirachamsinpeladobackend/inventario/serializers.py (lÃ­neas 318-332)

CÃ“DIGO ACTUAL (DOBLE SUMA):
---------------------------
```python
# Actualizar stock del producto
producto.stock_disponible += cantidad  # <-- SUMA MANUAL
producto.save()

# Crear movimiento de entrada
Movimiento.objects.create(
    producto=producto,
    tipo='entrada',  # <-- El signal TAMBIÃ‰N suma!
    cantidad=cantidad,
    descripcion=f"RecepciÃ³n #{recepcion.numero_recepcion}",
    usuario=usuario
)
```

SOLUCIÃ“N:
---------
Igual que en facturaciÃ³n: ELIMINAR la suma manual y dejar que SOLO el signal
maneje el stock.

```python
# Crear el detalle de recepciÃ³n
DetalleRecepcion.objects.create(recepcion=recepcion, **detalle)

# Crear movimiento de entrada (el signal maneja el stock)
Movimiento.objects.create(
    producto=producto,
    tipo='entrada',
    cantidad=cantidad,
    descripcion=f"RecepciÃ³n #{recepcion.numero_recepcion}",
    usuario=usuario
)
# NO hacer producto.stock_disponible += cantidad aquÃ­
```


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         ğŸ“‹ CÃ“DIGO CORREGIDO COMPLETO                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

A continuaciÃ³n, el mÃ©todo create() de FacturaSerializer completamente corregido:

```python
def create(self, validated_data):
    from django.db import transaction
    from decimal import Decimal
    from .models import Movimiento, DetalleFactura
    
    with transaction.atomic():
        detalles_data = validated_data.pop('detalles')
        usuario = self.context['request'].user if 'request' in self.context else None
        
        # Eliminar campos calculados que no deben venir del frontend
        validated_data.pop('usuario', None)
        validated_data.pop('subtotal', None)
        validated_data.pop('total', None)
        validated_data.pop('impuesto_total', None)
        
        # ========== PRE-VALIDACIÃ“N DE STOCK ==========
        for detalle in detalles_data:
            producto = detalle['producto']
            cantidad = detalle['cantidad']
            if producto.stock_disponible < cantidad:
                raise serializers.ValidationError(
                    f"Stock insuficiente para {producto.nombre}. "
                    f"Disponible: {producto.stock_disponible}, Solicitado: {cantidad}"
                )
        
        # ========== CREAR FACTURA ==========
        factura = Factura.objects.create(
            usuario=usuario, 
            total=0,
            **validated_data
        )
        
        subtotal = Decimal('0')
        
        # ========== PROCESAR DETALLES ==========
        for detalle in detalles_data:
            producto = detalle['producto']
            cantidad = detalle['cantidad']
            precio_unitario = detalle.get('precio_unitario', producto.precio_unitario)
            
            # Convertir a Decimal
            precio_unitario = Decimal(str(precio_unitario))
            cantidad_decimal = Decimal(str(cantidad))
            subtotal_detalle = cantidad_decimal * precio_unitario
            
            # Crear detalle de factura
            DetalleFactura.objects.create(
                factura=factura, 
                producto=producto, 
                cantidad=cantidad, 
                precio_unitario=precio_unitario, 
                subtotal=subtotal_detalle
            )
            
            # Crear movimiento de salida (EL SIGNAL MANEJA EL STOCK)
            Movimiento.objects.create(
                producto=producto,
                tipo='salida',
                cantidad=cantidad,
                descripcion=f"Venta (Factura #{factura.numero_factura})",
                usuario=usuario
            )
            
            subtotal += subtotal_detalle
        
        # ========== CALCULAR TOTALES ==========
        descuento_total = Decimal(str(validated_data.get('descuento_total', 0)))
        impuesto_total = (subtotal - descuento_total) * Decimal('0.10')  # IVA 10% PARAGUAY
        total = subtotal - descuento_total + impuesto_total
        
        # Actualizar factura con totales
        factura.subtotal = subtotal
        factura.impuesto_total = impuesto_total
        factura.total = total
        factura.save()
        
        return factura
```


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         ğŸ“‹ RESUMEN DE CAMBIOS REQUERIDOS                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ARCHIVO: serializers.py

| LÃ­nea(s)  | AcciÃ³n   | DescripciÃ³n                                      |
|-----------|----------|--------------------------------------------------|
| 90        | AGREGAR  | with transaction.atomic():                       |
| 93        | MOVER    | Imports de Decimal y Movimiento al inicio        |
| 106-108   | AGREGAR  | Pre-validaciÃ³n de stock (loop separado)          |
| 116-118   | ELIMINAR | Resta manual de stock (producto.stock -= cant)   |
| 156       | CAMBIAR  | Decimal('0.12') â†’ Decimal('0.10')                |
| 164-172   | ELIMINAR | Bloque try/except innecesario con atomic()       |
| 318-320   | ELIMINAR | Suma manual en RecepcionMercaderia               |

ARCHIVO: signals.py
- NO MODIFICAR - El signal estÃ¡ correcto, es el serializer el que estÃ¡ mal


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                              âš¡ PRIORIDAD DE FIX                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ğŸ”´ CRÃTICO: Doble resta de stock (BUG #1)
2. ğŸ”´ CRÃTICO: Transaction atomic (BUG #2)
3. ğŸŸ  ALTO: IVA incorrecto (BUG #3)
4. ğŸŸ¡ MEDIO: Pre-validaciÃ³n de stock (BUG #4)
5. ğŸŸ¢ BAJO: Imports repetidos (BUG #5)
6. ğŸŸ¡ MEDIO: Doble suma en recepciÃ³n (BUG #6)


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                              ğŸ§ª TESTING POST-FIX                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DespuÃ©s de aplicar los cambios, probar:

TEST 1: Factura Simple
----------------------
1. Producto A con stock 100
2. Crear factura con 5 unidades de Producto A
3. Verificar: stock debe ser 95 (no 90)

TEST 2: Factura con Error
-------------------------
1. Producto A con stock 10
2. Producto B con stock 2
3. Crear factura: 5x Producto A + 10x Producto B (debe fallar)
4. Verificar: stock de ambos productos debe quedar INTACTO (10 y 2)

TEST 3: IVA Correcto
--------------------
1. Crear factura con subtotal 100.000 Gs
2. IVA debe ser: 10.000 Gs (10%)
3. Total: 110.000 Gs

TEST 4: RecepciÃ³n de MercaderÃ­a
-------------------------------
1. Producto A con stock 50
2. Crear recepciÃ³n de 20 unidades
3. Verificar: stock debe ser 70 (no 90)


================================================================================
                        FIN DEL DOCUMENTO DE AUDITORÃA
================================================================================
                    Preparado para: Equipo de Desarrollo
                    Sistema: FerreterÃ­a J&G v2.0
================================================================================
